<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faminto ‚Äî Map Editor</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

    :root {
      --bg:        #0a0a0f;
      --panel:     #13131c;
      --panel2:    #1a1a28;
      --border:    #2a2a40;
      --accent:    #5b5ef4;
      --accent2:   #00e5a0;
      --danger:    #ff4d4d;
      --warn:      #ffa62b;
      --text:      #e8e8f0;
      --muted:     #6b6b8a;
      --grid-line: rgba(255,255,255,0.04);
      --grid-dot:  rgba(255,255,255,0.12);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
    #topbar {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 0 16px;
      height: 52px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      z-index: 10;
    }

    #topbar .logo {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin-right: 20px;
      color: var(--text);
    }
    #topbar .logo span { color: var(--accent); }

    #topbar .divider {
      width: 1px;
      height: 28px;
      background: var(--border);
      margin: 0 16px;
    }

    #topbar .map-title-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    #mapNameInput {
      background: transparent;
      border: none;
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 700;
      outline: none;
      width: 220px;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background 0.15s;
    }
    #mapNameInput:hover, #mapNameInput:focus {
      background: var(--panel2);
    }
    #mapNameInput::placeholder { color: var(--muted); font-weight: 400; }

    .tb-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 7px;
      border: none;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
      white-space: nowrap;
    }
    .tb-btn:active { transform: scale(0.96); }
    .tb-btn:hover { opacity: 0.85; }

    .tb-btn-ghost {
      background: var(--panel2);
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .tb-btn-ghost:hover { color: var(--text); }

    .tb-btn-accent {
      background: var(--accent);
      color: #fff;
    }

    .tb-btn-success {
      background: var(--accent2);
      color: #0a0a0f;
    }

    .tb-btn-danger {
      background: transparent;
      color: var(--danger);
      border: 1px solid var(--border);
    }
    .tb-btn-danger:hover { background: rgba(255,77,77,0.1); }

    .tb-gap { margin-left: auto; display: flex; gap: 8px; align-items: center; }

    /* ‚îÄ‚îÄ Object count badge ‚îÄ‚îÄ */
    #objCount {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--muted);
      padding: 4px 10px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
    #main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Left panel ‚îÄ‚îÄ */
    #left-panel {
      width: 220px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      flex-shrink: 0;
    }

    .panel-section {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
    }
    .panel-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    /* Tools */
    #tools { display: flex; flex-direction: column; gap: 4px; }
    .tool-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 7px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s;
      width: 100%;
      text-align: left;
    }
    .tool-btn .icon { font-size: 16px; width: 20px; text-align: center; }
    .tool-btn .kbd {
      margin-left: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 1px 5px;
      color: var(--muted);
    }
    .tool-btn:hover { background: var(--panel2); color: var(--text); }
    .tool-btn.active {
      background: rgba(91, 94, 244, 0.18);
      color: var(--accent);
      border: 1px solid rgba(91, 94, 244, 0.3);
    }

    /* Shape presets */
    #shape-presets {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    .shape-btn {
      padding: 10px 6px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: all 0.12s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .shape-btn .shape-icon {
      font-size: 20px;
      line-height: 1;
    }
    .shape-btn:hover {
      border-color: var(--accent);
      background: rgba(91, 94, 244, 0.1);
      color: var(--accent);
    }

    /* Color palette */
    #color-section {}
    .color-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    .color-swatch {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 5px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.1s, border-color 0.1s;
    }
    .color-swatch:hover { transform: scale(1.1); }
    .color-swatch.selected {
      border-color: #fff;
      transform: scale(1.15);
      box-shadow: 0 0 8px rgba(255,255,255,0.3);
    }

    .custom-color-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #customColorPicker {
      width: 36px;
      height: 28px;
      border: none;
      background: none;
      cursor: pointer;
      padding: 0;
      border-radius: 5px;
    }
    .custom-color-row label {
      font-size: 12px;
      color: var(--muted);
    }

    /* Properties panel */
    #props-section {}
    .prop-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .prop-label {
      font-size: 11px;
      color: var(--muted);
      width: 24px;
      flex-shrink: 0;
    }
    .prop-input {
      flex: 1;
      background: var(--panel2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 5px;
      outline: none;
    }
    .prop-input:focus { border-color: var(--accent); }
    .prop-input:disabled { opacity: 0.3; }

    .prop-slider {
      -webkit-appearance: none;
      flex: 1;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      outline: none;
    }
    .prop-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    /* Layer list */
    #layer-list {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-height: 200px;
      overflow-y: auto;
    }
    .layer-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
      transition: all 0.1s;
      border: 1px solid transparent;
    }
    .layer-item:hover { background: var(--panel2); color: var(--text); }
    .layer-item.selected {
      background: rgba(91,94,244,0.12);
      color: var(--accent);
      border-color: rgba(91,94,244,0.25);
    }
    .layer-dot {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }
    .layer-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .layer-del {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
      padding: 0 2px;
      line-height: 1;
      border-radius: 3px;
      opacity: 0;
    }
    .layer-item:hover .layer-del { opacity: 1; }
    .layer-del:hover { color: var(--danger); }

    /* ‚îÄ‚îÄ Canvas area ‚îÄ‚îÄ */
    #canvas-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      cursor: crosshair;
      background: var(--bg);
    }

    #editorCanvas {
      position: absolute;
      top: 0; left: 0;
      image-rendering: pixelated;
      touch-action: none; /* Prevent scroll/zoom gestures hijacking canvas */
    }

    /* Canvas overlay messages */
    #canvas-hint {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(10,10,15,0.85);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 12px;
      color: var(--muted);
      pointer-events: none;
      transition: opacity 0.3s;
      white-space: nowrap;
      backdrop-filter: blur(8px);
    }

    /* Coordinates display */
    #coords {
      position: absolute;
      top: 10px;
      right: 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      background: rgba(10,10,15,0.7);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      pointer-events: none;
    }

    /* zoom controls */
    #zoom-controls {
      position: absolute;
      bottom: 16px;
      right: 16px;
      display: flex;
      gap: 4px;
    }
    .zoom-btn {
      width: 30px;
      height: 30px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s;
    }
    .zoom-btn:hover { background: var(--panel2); border-color: var(--accent); }

    /* ‚îÄ‚îÄ Right panel ‚îÄ‚îÄ */
    #right-panel {
      width: 200px;
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Mini map ‚îÄ‚îÄ */
    #minimap-wrap {
      padding: 14px;
      border-bottom: 1px solid var(--border);
    }
    #minimap {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      border: 1px solid var(--border);
      display: block;
    }

    /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
    #stats-section {
      padding: 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 12px;
    }
    .stat-label { color: var(--muted); }
    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
    }
    .stat-value.accent { color: var(--accent2); }

    /* ‚îÄ‚îÄ JSON preview ‚îÄ‚îÄ */
    #json-preview-section { padding: 14px; flex: 1; display: flex; flex-direction: column; }
    #jsonPreview {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      line-height: 1.5;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      overflow: auto;
      flex: 1;
      max-height: 200px;
      white-space: pre;
    }

    /* ‚îÄ‚îÄ Toast notification ‚îÄ‚îÄ */
    #toast {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      pointer-events: none;
      opacity: 0;
      transition: all 0.25s;
      z-index: 1000;
      backdrop-filter: blur(12px);
      white-space: nowrap;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    #toast.success { border-color: var(--accent2); color: var(--accent2); }
    #toast.error { border-color: var(--danger); color: var(--danger); }

    /* ‚îÄ‚îÄ Selection box ‚îÄ‚îÄ */
    #selection-box {
      position: absolute;
      border: 1px dashed rgba(91,94,244,0.7);
      background: rgba(91,94,244,0.06);
      pointer-events: none;
      display: none;
    }

    /* ‚îÄ‚îÄ Mobile responsive ‚îÄ‚îÄ */
    @media (max-width: 700px) {
      #left-panel, #right-panel { display: none; }
      #topbar { padding: 0 8px; overflow-x: auto; }
      #topbar .logo { font-size: 16px; margin-right: 8px; }
      #mapNameInput { width: 110px; font-size: 13px; }
      .tb-btn { padding: 5px 8px; font-size: 11px; }
      #objCount { display: none; }
      #mobile-toolbar { display: flex !important; }
      #canvas-area { padding-bottom: 64px; }
    }
    #mobile-toolbar {
      display: none;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 64px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      align-items: center;
      justify-content: space-around;
      z-index: 50;
      padding: 0 4px;
    }
    .mob-tool-btn {
      display: flex; flex-direction: column; align-items: center;
      gap: 2px; background: none; border: none;
      color: var(--muted); font-size: 9px;
      font-family: 'Space Grotesk', sans-serif;
      cursor: pointer; padding: 6px 8px; border-radius: 8px;
      min-width: 44px; min-height: 44px; justify-content: center;
    }
    .mob-tool-btn .icon { font-size: 19px; line-height: 1; }
    .mob-tool-btn.active { color: var(--accent); background: rgba(91,94,244,0.15); }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  </style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <div class="logo">‚ö´ <span>Faminto</span></div>
  <div class="divider"></div>
  <div class="map-title-wrap">
    <input id="mapNameInput" type="text" placeholder="Untitled Map" maxlength="30" />
  </div>
  <div class="tb-gap">
    <div id="objCount">0 objects</div>
    <div class="divider"></div>
    <button class="tb-btn tb-btn-ghost" id="btnUndo" title="Undo (Ctrl+Z)">‚Ü© Undo</button>
    <button class="tb-btn tb-btn-ghost" id="btnRedo" title="Redo (Ctrl+Y)">‚Ü™ Redo</button>
    <div class="divider"></div>
    <button class="tb-btn tb-btn-ghost" id="btnClear">üóë Clear</button>
    <button class="tb-btn tb-btn-ghost" id="btnLoad">üìÇ Load JSON</button>
    <button class="tb-btn tb-btn-ghost" id="btnExport">üìã Copy JSON</button>
    <button class="tb-btn tb-btn-success" id="btnSave">üíæ Save Map</button>
    <div class="divider"></div>
    <button class="tb-btn tb-btn-ghost" id="btnBack">‚Üê Back</button>
  </div>
</div>

<div id="main">

  <!-- LEFT PANEL -->
  <div id="left-panel">

    <div class="panel-section">
      <div class="panel-label">Tools</div>
      <div id="tools">
        <button class="tool-btn active" data-tool="place" id="tool-place">
          <span class="icon">‚úö</span> Place
          <span class="kbd">V</span>
        </button>
        <button class="tool-btn" data-tool="select" id="tool-select">
          <span class="icon">‚Üñ</span> Select
          <span class="kbd">S</span>
        </button>
        <button class="tool-btn" data-tool="move" id="tool-move">
          <span class="icon">‚ú•</span> Move
          <span class="kbd">M</span>
        </button>
        <button class="tool-btn" data-tool="resize" id="tool-resize">
          <span class="icon">‚§¢</span> Resize
          <span class="kbd">R</span>
        </button>
        <button class="tool-btn" data-tool="erase" id="tool-erase">
          <span class="icon">‚úï</span> Erase
          <span class="kbd">E</span>
        </button>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-label">Shape Presets</div>
      <div id="shape-presets">
        <button class="shape-btn" data-w="4" data-h="4" data-label="Small">
          <span class="shape-icon">‚ñ™</span>Small
        </button>
        <button class="shape-btn" data-w="6" data-h="6" data-label="Medium">
          <span class="shape-icon">‚óº</span>Medium
        </button>
        <button class="shape-btn" data-w="10" data-h="4" data-label="Wall H">
          <span class="shape-icon">‚ñ¨</span>Wall H
        </button>
        <button class="shape-btn" data-w="4" data-h="10" data-label="Wall V">
          <span class="shape-icon">‚ñÆ</span>Wall V
        </button>
        <button class="shape-btn" data-w="12" data-h="12" data-label="Large">
          <span class="shape-icon">‚¨õ</span>Large
        </button>
        <button class="shape-btn" data-w="20" data-h="3" data-label="Platform">
          <span class="shape-icon">‚îÅ</span>Platform
        </button>
      </div>
    </div>

    <div class="panel-section" id="color-section">
      <div class="panel-label">Colour</div>
      <div class="color-grid" id="colorGrid"></div>
      <div class="custom-color-row">
        <input type="color" id="customColorPicker" value="#5b5ef4" />
        <label>Custom colour</label>
      </div>
    </div>

    <div class="panel-section" id="props-section">
      <div class="panel-label">Selected Object</div>
      <div class="prop-row">
        <span class="prop-label">X</span>
        <input class="prop-input" id="propX" type="number" placeholder="‚Äî" disabled />
      </div>
      <div class="prop-row">
        <span class="prop-label">Y</span>
        <input class="prop-input" id="propY" type="number" placeholder="‚Äî" disabled />
      </div>
      <div class="prop-row">
        <span class="prop-label">W</span>
        <input class="prop-input" id="propW" type="number" placeholder="‚Äî" min="1" disabled />
      </div>
      <div class="prop-row">
        <span class="prop-label">H</span>
        <input class="prop-input" id="propH" type="number" placeholder="‚Äî" min="1" disabled />
      </div>
      <div class="prop-row" style="margin-top:4px">
        <span class="prop-label" style="color:var(--muted);font-size:10px">height</span>
        <input class="prop-slider" id="propHeight3D" type="range" min="1" max="12" value="3" step="0.5" disabled />
        <span id="propHeightVal" style="font-family:JetBrains Mono,monospace;font-size:11px;color:var(--muted);width:28px;text-align:right">3</span>
      </div>
    </div>

    <div class="panel-section" style="flex:1;min-height:100px">
      <div class="panel-label">Objects (<span id="layerCount">0</span>)</div>
      <div id="layer-list"></div>
    </div>

  </div>

  <!-- CANVAS AREA -->
  <div id="canvas-area">
    <canvas id="editorCanvas"></canvas>
    <div id="coords">0, 0</div>
    <div id="canvas-hint">Click to place ¬∑ Drag to size ¬∑ Click an object with Select to edit</div>
    <div id="selection-box"></div>
    <div id="zoom-controls">
      <button class="zoom-btn" id="zoomIn">+</button>
      <button class="zoom-btn" id="zoomReset">‚åÇ</button>
      <button class="zoom-btn" id="zoomOut">‚àí</button>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div id="right-panel">

    <div class="minimap-wrap" id="minimap-wrap">
      <div class="panel-label" style="padding:14px 14px 8px;margin:0">Minimap</div>
      <div style="padding:0 14px 14px">
        <canvas id="minimap" width="172" height="172"></canvas>
      </div>
    </div>

    <div id="stats-section">
      <div class="panel-label">Map Stats</div>
      <div class="stat-row">
        <span class="stat-label">Objects</span>
        <span class="stat-value accent" id="statObjects">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Area filled</span>
        <span class="stat-value" id="statArea">0%</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Zoom</span>
        <span class="stat-value" id="statZoom">100%</span>
      </div>
    </div>

    <div id="json-preview-section">
      <div class="panel-label" style="margin-bottom:8px">JSON Preview</div>
      <div id="jsonPreview">// Place objects to see preview</div>
    </div>

  </div>

</div>

<div id="toast"></div>

<!-- Hidden file input for loading -->
<input type="file" id="fileInput" accept=".json" style="display:none" />

<!-- Mobile bottom toolbar (visible only on small screens) -->
<div id="mobile-toolbar">
  <button class="mob-tool-btn active" data-tool="place" id="mob-tool-place">
    <span class="icon">‚úö</span>Place
  </button>
  <button class="mob-tool-btn" data-tool="select" id="mob-tool-select">
    <span class="icon">‚Üñ</span>Select
  </button>
  <button class="mob-tool-btn" data-tool="move" id="mob-tool-move">
    <span class="icon">‚ú•</span>Move
  </button>
  <button class="mob-tool-btn" data-tool="erase" id="mob-tool-erase">
    <span class="icon">‚úï</span>Erase
  </button>
  <button class="mob-tool-btn" id="mob-btn-undo">
    <span class="icon">‚Ü©</span>Undo
  </button>
  <button class="mob-tool-btn" id="mob-btn-save" style="color:var(--accent2)">
    <span class="icon">üíæ</span>Save
  </button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FAMINTO MAP EDITOR ‚Äî Stage 1
//  Pure browser, no server communication yet.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const PALETTE = [
  '#E74C3C','#E67E22','#F1C40F','#2ECC71','#1ABC9C',
  '#3498DB','#9B59B6','#E91E63','#FF5722','#8BC34A',
  '#00BCD4','#607D8B','#795548','#FFFFFF','#BDBDBD',
  '#212121','#5b5ef4','#00e5a0','#ffa62b','#ff4d4d',
];

// Map world size in "units" ‚Äî matches the game's ~110x110 units
const WORLD_SIZE = 110;
// Grid cell = 1 unit
const GRID_CELL = 1;

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let objects = [];    // { id, x, y, w, h, color, height3d }  (x,y,w,h in world units)
let selectedId = null;
let currentTool = 'place';
let currentColor = '#E74C3C';
let currentPreset = { w: 6, h: 6 };
let zoom = 1;
let panX = 0;
let panY = 0;
let undoStack = [];
let redoStack = [];
let nextId = 1;

// Drag state
let isDragging = false;
let dragMode = null; // 'place-drag', 'move', 'resize'
let dragStart = { wx: 0, wy: 0, mx: 0, my: 0 };
let dragObj = null;  // snapshot of object at drag start

const canvas = document.getElementById('editorCanvas');
const ctx = canvas.getContext('2d');
const miniCanvas = document.getElementById('minimap');
const miniCtx = miniCanvas.getContext('2d');

// ‚îÄ‚îÄ Resize canvas to fill area ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resizeCanvas() {
  const area = document.getElementById('canvas-area');
  canvas.width  = area.clientWidth;
  canvas.height = area.clientHeight;
  // Centre the world on first load
  if (panX === 0 && panY === 0) {
    panX = canvas.width  / 2;
    panY = canvas.height / 2;
  }
  render();
}
new ResizeObserver(resizeCanvas).observe(document.getElementById('canvas-area'));

// ‚îÄ‚îÄ Coordinate conversion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// World origin = (0,0) = centre of the map
// Screen origin = top-left corner
function worldToScreen(wx, wy) {
  return {
    sx: panX + wx * zoom,
    sy: panY + wy * zoom
  };
}
function screenToWorld(sx, sy) {
  return {
    wx: (sx - panX) / zoom,
    wy: (sy - panY) / zoom
  };
}
function snapToGrid(val) {
  return Math.round(val / GRID_CELL) * GRID_CELL;
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const W = canvas.width;
  const H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  // Background
  ctx.fillStyle = '#0a0a0f';
  ctx.fillRect(0, 0, W, H);

  // Grid dots
  const gridStep = GRID_CELL * zoom;
  if (gridStep > 6) {
    const startX = ((panX % gridStep) + gridStep) % gridStep;
    const startY = ((panY % gridStep) + gridStep) % gridStep;
    ctx.fillStyle = 'rgba(255,255,255,0.07)';
    for (let x = startX; x < W; x += gridStep) {
      for (let y = startY; y < H; y += gridStep) {
        ctx.fillRect(x - 0.5, y - 0.5, 1, 1);
      }
    }
  }

  // World boundary
  const hs = WORLD_SIZE / 2;
  const tl = worldToScreen(-hs, -hs);
  const br = worldToScreen( hs,  hs);
  const bw = (br.sx - tl.sx);
  const bh = (br.sy - tl.sy);

  // Map ground
  ctx.fillStyle = '#1a2a1a';
  ctx.fillRect(tl.sx, tl.sy, bw, bh);

  // Checkerboard ground (subtle)
  const tileWorld = 10;
  const tilePx = tileWorld * zoom;
  if (tilePx > 4) {
    const tilesX = Math.ceil(WORLD_SIZE / tileWorld) + 1;
    const tilesY = Math.ceil(WORLD_SIZE / tileWorld) + 1;
    for (let r = 0; r < tilesY; r++) {
      for (let c = 0; c < tilesX; c++) {
        if ((r + c) % 2 === 0) {
          const p = worldToScreen(-hs + c * tileWorld, -hs + r * tileWorld);
          ctx.fillStyle = 'rgba(93,187,93,0.08)';
          ctx.fillRect(p.sx, p.sy, tilePx, tilePx);
        }
      }
    }
  }

  // Map boundary outline
  ctx.strokeStyle = 'rgba(91,94,244,0.4)';
  ctx.lineWidth = 2;
  ctx.setLineDash([8, 6]);
  ctx.strokeRect(tl.sx, tl.sy, bw, bh);
  ctx.setLineDash([]);

  // Corner labels
  ctx.fillStyle = 'rgba(91,94,244,0.5)';
  ctx.font = '11px JetBrains Mono, monospace';
  ctx.fillText('-55,-55', tl.sx + 4, tl.sy + 14);
  ctx.fillText('55,55',   br.sx - 50, br.sy - 4);

  // Sort objects so selected renders on top
  const sortedObjs = [...objects].sort((a, b) =>
    (a.id === selectedId ? 1 : 0) - (b.id === selectedId ? 1 : 0)
  );

  // Objects
  for (const obj of sortedObjs) {
    const p  = worldToScreen(obj.x, obj.y);
    const pw = obj.w * zoom;
    const ph = obj.h * zoom;
    const isSelected = obj.id === selectedId;

    // Drop shadow
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.fillRect(p.sx + 3, p.sy + 3, pw, ph);

    // Object fill
    ctx.fillStyle = obj.color;
    ctx.fillRect(p.sx, p.sy, pw, ph);

    // Gradient top highlight
    const grad = ctx.createLinearGradient(p.sx, p.sy, p.sx, p.sy + ph * 0.4);
    grad.addColorStop(0, 'rgba(255,255,255,0.18)');
    grad.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = grad;
    ctx.fillRect(p.sx, p.sy, pw, ph);

    // Height indicator (small bar on left edge)
    const heightFrac = Math.min(obj.height3d / 12, 1);
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.fillRect(p.sx, p.sy + ph * (1 - heightFrac), 3, ph * heightFrac);

    // Border
    ctx.strokeStyle = isSelected ? '#5b5ef4' : 'rgba(0,0,0,0.5)';
    ctx.lineWidth = isSelected ? 2 : 1;
    ctx.strokeRect(p.sx, p.sy, pw, ph);

    // Selection handles
    if (isSelected) {
      ctx.fillStyle = '#5b5ef4';
      const hs2 = 5;
      // corners
      [
        [p.sx,       p.sy      ],
        [p.sx + pw,  p.sy      ],
        [p.sx,       p.sy + ph ],
        [p.sx + pw,  p.sy + ph ],
        // midpoints
        [p.sx + pw/2, p.sy      ],
        [p.sx + pw/2, p.sy + ph ],
        [p.sx,        p.sy + ph/2],
        [p.sx + pw,   p.sy + ph/2],
      ].forEach(([hx, hy]) => {
        ctx.fillRect(hx - hs2, hy - hs2, hs2*2, hs2*2);
      });

      // Label
      ctx.fillStyle = 'rgba(91,94,244,0.9)';
      ctx.font = 'bold 10px Space Grotesk, sans-serif';
      ctx.fillText(
        `${obj.w}√ó${obj.h} ¬∑ h:${obj.height3d}`,
        p.sx + 2,
        p.sy - 4
      );
    }
  }

  // Draw place-drag preview
  if (isDragging && dragMode === 'place-drag' && dragObj) {
    const p  = worldToScreen(dragObj.x, dragObj.y);
    const pw = dragObj.w * zoom;
    const ph = dragObj.h * zoom;
    ctx.fillStyle = currentColor + 'aa';
    ctx.fillRect(p.sx, p.sy, pw, ph);
    ctx.strokeStyle = '#5b5ef4';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([4,3]);
    ctx.strokeRect(p.sx, p.sy, pw, ph);
    ctx.setLineDash([]);
  }

  updateMinimap();
  updateStats();
  updateJSONPreview();
  updateObjCount();
  updateLayerList();
  updatePropPanel();
}

// ‚îÄ‚îÄ Minimap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateMinimap() {
  const mW = miniCanvas.width;
  const mH = miniCanvas.height;
  miniCtx.clearRect(0, 0, mW, mH);

  miniCtx.fillStyle = '#1a2a1a';
  miniCtx.fillRect(0, 0, mW, mH);

  const scale = mW / WORLD_SIZE;
  const offX = mW / 2;
  const offY = mH / 2;

  for (const obj of objects) {
    miniCtx.fillStyle = obj.color;
    miniCtx.fillRect(
      offX + obj.x * scale,
      offY + obj.y * scale,
      Math.max(obj.w * scale, 1.5),
      Math.max(obj.h * scale, 1.5)
    );
  }

  // Viewport indicator
  const vw = canvas.width  / zoom;
  const vh = canvas.height / zoom;
  const vx = -panX / zoom;
  const vy = -panY / zoom;
  miniCtx.strokeStyle = 'rgba(91,94,244,0.6)';
  miniCtx.lineWidth = 1;
  miniCtx.strokeRect(
    offX + vx * scale,
    offY + vy * scale,
    vw * scale,
    vh * scale
  );

  // Border
  miniCtx.strokeStyle = 'rgba(91,94,244,0.3)';
  miniCtx.lineWidth = 1;
  miniCtx.strokeRect(0, 0, mW, mH);
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
  document.getElementById('statObjects').textContent = objects.length;
  const totalArea = objects.reduce((a, o) => a + o.w * o.h, 0);
  const mapArea = WORLD_SIZE * WORLD_SIZE;
  const pct = Math.min(100, (totalArea / mapArea * 100)).toFixed(1);
  document.getElementById('statArea').textContent = pct + '%';
  document.getElementById('statZoom').textContent = Math.round(zoom * 100) + '%';
}

function updateObjCount() {
  document.getElementById('objCount').textContent = objects.length + ' object' + (objects.length !== 1 ? 's' : '');
  document.getElementById('layerCount').textContent = objects.length;
}

// ‚îÄ‚îÄ JSON preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateJSONPreview() {
  const preview = document.getElementById('jsonPreview');
  if (objects.length === 0) {
    preview.textContent = '// Place objects to\n// see preview';
    return;
  }
  const data = buildMapJSON();
  const lines = JSON.stringify(data, null, 2).split('\n').slice(0, 30);
  if (JSON.stringify(data, null, 2).split('\n').length > 30) lines.push('...');
  preview.textContent = lines.join('\n');
}

// ‚îÄ‚îÄ Layer list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateLayerList() {
  const el = document.getElementById('layer-list');
  el.innerHTML = objects.slice().reverse().map(obj => `
    <div class="layer-item ${obj.id === selectedId ? 'selected' : ''}" data-id="${obj.id}">
      <div class="layer-dot" style="background:${obj.color}"></div>
      <span class="layer-name">Box ${obj.id} (${obj.w}√ó${obj.h})</span>
      <button class="layer-del" data-del="${obj.id}">√ó</button>
    </div>
  `).join('');
  el.querySelectorAll('.layer-item').forEach(el2 => {
    el2.addEventListener('click', (e) => {
      if (e.target.dataset.del) return;
      selectObject(parseInt(el2.dataset.id));
    });
  });
  el.querySelectorAll('.layer-del').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      deleteObject(parseInt(btn.dataset.del));
    });
  });
}

// ‚îÄ‚îÄ Property panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updatePropPanel() {
  const obj = objects.find(o => o.id === selectedId);
  const fields = ['propX','propY','propW','propH','propHeight3D'];
  if (!obj) {
    fields.forEach(f => {
      const el = document.getElementById(f);
      el.disabled = true;
      el.value = '';
    });
    document.getElementById('propHeightVal').textContent = '‚Äî';
    return;
  }
  document.getElementById('propX').disabled = false;
  document.getElementById('propY').disabled = false;
  document.getElementById('propW').disabled = false;
  document.getElementById('propH').disabled = false;
  document.getElementById('propHeight3D').disabled = false;
  document.getElementById('propX').value = Math.round(obj.x);
  document.getElementById('propY').value = Math.round(obj.y);
  document.getElementById('propW').value = obj.w;
  document.getElementById('propH').value = obj.h;
  document.getElementById('propHeight3D').value = obj.height3d;
  document.getElementById('propHeightVal').textContent = obj.height3d;
}

// ‚îÄ‚îÄ Object management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pushUndo() {
  undoStack.push(JSON.stringify(objects));
  redoStack = [];
  if (undoStack.length > 50) undoStack.shift();
}

function createObject(x, y, w, h) {
  return {
    id: nextId++,
    x: snapToGrid(x),
    y: snapToGrid(y),
    w: Math.max(1, w),
    h: Math.max(1, h),
    color: currentColor,
    height3d: 3
  };
}

function addObject(obj) {
  objects.push(obj);
  selectObject(obj.id);
}

function deleteObject(id) {
  pushUndo();
  objects = objects.filter(o => o.id !== id);
  if (selectedId === id) selectedId = null;
  render();
}

function selectObject(id) {
  selectedId = id;
  const obj = objects.find(o => o.id === id);
  if (obj) {
    currentColor = obj.color;
    updateColorSelection();
  }
  render();
}

function getObjectAt(wx, wy) {
  // Return topmost object at world coordinate
  for (let i = objects.length - 1; i >= 0; i--) {
    const obj = objects[i];
    if (wx >= obj.x && wx <= obj.x + obj.w &&
        wy >= obj.y && wy <= obj.y + obj.h) {
      return obj;
    }
  }
  return null;
}

// ‚îÄ‚îÄ Build map JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildMapJSON() {
  return {
    name: document.getElementById('mapNameInput').value.trim() || 'Untitled Map',
    version: 1,
    worldSize: WORLD_SIZE,
    objects: objects.map(obj => ({
      x: obj.x,
      z: obj.y,      // note: y in editor = z in 3D
      w: obj.w,
      d: obj.h,      // depth
      h: obj.height3d,
      color: obj.color
    }))
  };
}

// ‚îÄ‚îÄ Undo / Redo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function undo() {
  if (!undoStack.length) return;
  redoStack.push(JSON.stringify(objects));
  objects = JSON.parse(undoStack.pop());
  selectedId = null;
  render();
  showToast('Undone', 'default');
}

function redo() {
  if (!redoStack.length) return;
  undoStack.push(JSON.stringify(objects));
  objects = JSON.parse(redoStack.pop());
  selectedId = null;
  render();
  showToast('Redone', 'default');
}

// ‚îÄ‚îÄ Mouse events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCanvasPos(e) {
  const rect = canvas.getBoundingClientRect();
  return { mx: e.clientX - rect.left, my: e.clientY - rect.top };
}

let isPanning = false;
let panStart = { mx: 0, my: 0, panX: 0, panY: 0 };

canvas.addEventListener('mousedown', (e) => {
  if (e.button === 1 || (e.button === 0 && e.altKey)) {
    // Middle-click or Alt+drag = pan
    isPanning = true;
    panStart = { mx: e.clientX, my: e.clientY, panX, panY };
    canvas.style.cursor = 'grab';
    return;
  }
  if (e.button !== 0) return;

  const { mx, my } = getCanvasPos(e);
  const { wx, wy } = screenToWorld(mx, my);

  if (currentTool === 'place') {
    pushUndo();
    isDragging = true;
    dragMode = 'place-drag';
    dragStart = { wx, wy, mx, my };
    dragObj = createObject(wx - currentPreset.w / 2, wy - currentPreset.h / 2, currentPreset.w, currentPreset.h);
  } else if (currentTool === 'select') {
    const hit = getObjectAt(wx, wy);
    if (hit) selectObject(hit.id);
    else { selectedId = null; render(); }
  } else if (currentTool === 'move') {
    const hit = getObjectAt(wx, wy);
    if (hit) {
      pushUndo();
      selectObject(hit.id);
      isDragging = true;
      dragMode = 'move';
      dragStart = { wx, wy };
      dragObj = { ...hit };
    }
  } else if (currentTool === 'resize') {
    const hit = getObjectAt(wx, wy);
    if (hit) {
      pushUndo();
      selectObject(hit.id);
      isDragging = true;
      dragMode = 'resize';
      dragStart = { wx, wy };
      dragObj = { ...hit };
    }
  } else if (currentTool === 'erase') {
    const hit = getObjectAt(wx, wy);
    if (hit) deleteObject(hit.id);
  }
});

canvas.addEventListener('mousemove', (e) => {
  if (isPanning) {
    panX = panStart.panX + (e.clientX - panStart.mx);
    panY = panStart.panY + (e.clientY - panStart.my);
    render();
    return;
  }

  const { mx, my } = getCanvasPos(e);
  const { wx, wy } = screenToWorld(mx, my);

  // Update coords display
  document.getElementById('coords').textContent =
    `${Math.round(wx)}, ${Math.round(wy)}`;

  if (!isDragging) return;

  if (dragMode === 'place-drag') {
    const sx = snapToGrid(Math.min(wx, dragStart.wx));
    const sy = snapToGrid(Math.min(wy, dragStart.wy));
    const sw = Math.max(1, Math.abs(snapToGrid(wx) - snapToGrid(dragStart.wx)));
    const sh = Math.max(1, Math.abs(snapToGrid(wy) - snapToGrid(dragStart.wy)));
    dragObj = { ...dragObj, x: sx, y: sy, w: sw, h: sh };
    render();
  } else if (dragMode === 'move') {
    const dWx = wx - dragStart.wx;
    const dWy = wy - dragStart.wy;
    const obj = objects.find(o => o.id === selectedId);
    if (obj) {
      obj.x = snapToGrid(dragObj.x + dWx);
      obj.y = snapToGrid(dragObj.y + dWy);
      render();
    }
  } else if (dragMode === 'resize') {
    const obj = objects.find(o => o.id === selectedId);
    if (obj) {
      obj.w = Math.max(1, snapToGrid(dragObj.w + (wx - dragStart.wx)));
      obj.h = Math.max(1, snapToGrid(dragObj.h + (wy - dragStart.wy)));
      render();
    }
  }
});

canvas.addEventListener('mouseup', (e) => {
  canvas.style.cursor = '';
  if (isPanning) { isPanning = false; return; }
  if (!isDragging) return;

  if (dragMode === 'place-drag' && dragObj) {
    if (dragObj.w > 0 && dragObj.h > 0) {
      addObject({ ...dragObj });
    }
  }

  isDragging = false;
  dragMode = null;
  dragObj = null;
  render();
});

canvas.addEventListener('mouseleave', () => {
  isDragging = false;
  isPanning = false;
  dragMode = null;
  dragObj = null;
  canvas.style.cursor = '';
  render();
});

// Wheel zoom
canvas.addEventListener('wheel', (e) => {
  e.preventDefault();
  const { mx, my } = getCanvasPos(e);
  const factor = e.deltaY > 0 ? 0.9 : 1.1;
  const newZoom = Math.max(0.15, Math.min(8, zoom * factor));

  // Zoom toward mouse position
  panX = mx - (mx - panX) * (newZoom / zoom);
  panY = my - (my - panY) * (newZoom / zoom);
  zoom = newZoom;
  document.getElementById('statZoom').textContent = Math.round(zoom * 100) + '%';
  render();
}, { passive: false });

// ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT') return;
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'z') { e.preventDefault(); undo(); }
    if (e.key === 'y') { e.preventDefault(); redo(); }
    if (e.key === 'c' && selectedId) {
      const obj = objects.find(o => o.id === selectedId);
      if (obj) {
        pushUndo();
        const clone = { ...obj, id: nextId++, x: obj.x + 4, y: obj.y + 4 };
        addObject(clone);
      }
    }
    return;
  }
  switch (e.key.toLowerCase()) {
    case 'v': setTool('place'); break;
    case 's': setTool('select'); break;
    case 'm': setTool('move'); break;
    case 'r': setTool('resize'); break;
    case 'e': setTool('erase'); break;
    case 'delete':
    case 'backspace':
      if (selectedId) deleteObject(selectedId);
      break;
    case 'escape':
      selectedId = null; render();
      break;
  }
});

// ‚îÄ‚îÄ Tool switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTool(name) {
  currentTool = name;
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('tool-' + name);
  if (btn) btn.classList.add('active');
  const cursors = { place: 'crosshair', select: 'default', move: 'move', resize: 'se-resize', erase: 'not-allowed' };
  canvas.style.cursor = cursors[name] || 'crosshair';
  updateHint();
}

document.querySelectorAll('.tool-btn').forEach(btn => {
  btn.addEventListener('click', () => setTool(btn.dataset.tool));
});

function updateHint() {
  const hints = {
    place:  'Click & drag to draw ¬∑ Release to place',
    select: 'Click an object to select ¬∑ Delete to remove',
    move:   'Click an object then drag to move',
    resize: 'Click an object then drag corner to resize',
    erase:  'Click an object to erase it'
  };
  document.getElementById('canvas-hint').textContent = hints[currentTool] || '';
}

// ‚îÄ‚îÄ Shape presets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.shape-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    currentPreset.w = parseInt(btn.dataset.w);
    currentPreset.h = parseInt(btn.dataset.h);
    setTool('place');
    showToast(`Preset: ${btn.dataset.label} (${btn.dataset.w}√ó${btn.dataset.h})`, 'default');
  });
});

// ‚îÄ‚îÄ Colour palette ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPalette() {
  const grid = document.getElementById('colorGrid');
  grid.innerHTML = '';
  PALETTE.forEach(color => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (color === currentColor ? ' selected' : '');
    sw.style.background = color;
    sw.dataset.color = color;
    sw.addEventListener('click', () => {
      currentColor = color;
      updateColorSelection();
      applyColorToSelected();
    });
    grid.appendChild(sw);
  });
}

function updateColorSelection() {
  document.querySelectorAll('.color-swatch').forEach(sw => {
    sw.classList.toggle('selected', sw.dataset.color === currentColor);
  });
  document.getElementById('customColorPicker').value = currentColor;
}

function applyColorToSelected() {
  const obj = objects.find(o => o.id === selectedId);
  if (obj) {
    pushUndo();
    obj.color = currentColor;
    render();
  }
}

document.getElementById('customColorPicker').addEventListener('input', (e) => {
  currentColor = e.target.value;
  updateColorSelection();
  applyColorToSelected();
});

buildPalette();

// ‚îÄ‚îÄ Property inputs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
['propX','propY','propW','propH'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    const obj = objects.find(o => o.id === selectedId);
    if (!obj) return;
    pushUndo();
    const val = parseFloat(document.getElementById(id).value);
    if (isNaN(val)) return;
    const map = { propX: 'x', propY: 'y', propW: 'w', propH: 'h' };
    obj[map[id]] = id === 'propW' || id === 'propH' ? Math.max(1, val) : val;
    render();
  });
});

document.getElementById('propHeight3D').addEventListener('input', (e) => {
  const obj = objects.find(o => o.id === selectedId);
  if (!obj) return;
  obj.height3d = parseFloat(e.target.value);
  document.getElementById('propHeightVal').textContent = obj.height3d;
  render();
});

// ‚îÄ‚îÄ Zoom buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('zoomIn').addEventListener('click', () => {
  zoom = Math.min(8, zoom * 1.25);
  render();
});
document.getElementById('zoomOut').addEventListener('click', () => {
  zoom = Math.max(0.15, zoom / 1.25);
  render();
});
document.getElementById('zoomReset').addEventListener('click', () => {
  zoom = 1;
  panX = canvas.width  / 2;
  panY = canvas.height / 2;
  render();
});

// ‚îÄ‚îÄ Top bar actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btnUndo').addEventListener('click', undo);
document.getElementById('btnRedo').addEventListener('click', redo);

document.getElementById('btnClear').addEventListener('click', () => {
  if (objects.length === 0) return;
  if (!confirm('Clear all objects? This cannot be undone.')) return;
  undoStack = []; redoStack = [];
  objects = [];
  selectedId = null;
  render();
  showToast('Canvas cleared', 'default');
});

document.getElementById('btnExport').addEventListener('click', () => {
  const json = JSON.stringify(buildMapJSON(), null, 2);
  navigator.clipboard.writeText(json).then(() => {
    showToast('‚úì JSON copied to clipboard', 'success');
  }).catch(() => {
    // Fallback: show in a prompt
    prompt('Copy this JSON:', json);
  });
});

document.getElementById('btnLoad').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      pushUndo();
      loadMapData(data);
      showToast('‚úì Map loaded', 'success');
    } catch {
      showToast('Invalid JSON file', 'error');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

function loadMapData(data) {
  objects = [];
  nextId = 1;
  if (data.name) document.getElementById('mapNameInput').value = data.name;
  if (data.objects) {
    for (const obj of data.objects) {
      objects.push({
        id: nextId++,
        x: obj.x || 0,
        y: obj.z || obj.y || 0,   // stage 2 uses z for 3D
        w: obj.w || 6,
        h: obj.d || obj.h || 6,
        color: obj.color || '#E74C3C',
        height3d: obj.h || 3
      });
    }
  }
  selectedId = null;
  render();
}

document.getElementById('btnSave').addEventListener('click', () => {
  if (objects.length === 0) {
    showToast('Add some objects first!', 'error');
    return;
  }
  const json = JSON.stringify(buildMapJSON(), null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const name = (document.getElementById('mapNameInput').value.trim() || 'untitled-map')
    .toLowerCase().replace(/\s+/g, '-');
  a.href = url;
  a.download = name + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('‚úì Map saved as ' + name + '.json', 'success');
});

document.getElementById('btnBack').addEventListener('click', () => {
  if (objects.length > 0) {
    if (!confirm('Go back? Unsaved changes will be lost.')) return;
  }
  // In the full integration this will show the welcome screen
  // For now, just reload
  if (window.opener) window.close();
  else window.history.back();
});

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type = 'default') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show' + (type !== 'default' ? ' ' + type : '');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.className = ''; }, 2400);
}

// ‚îÄ‚îÄ Touch support ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Converts TouchEvents into synthetic MouseEvents so all
// existing mousedown/mousemove/mouseup logic works on mobile.

function touchToMouse(type, touch) {
  canvas.dispatchEvent(new MouseEvent(type, {
    bubbles: true, cancelable: true,
    clientX: touch.clientX,
    clientY: touch.clientY,
    button: 0, buttons: type === 'mouseup' ? 0 : 1
  }));
}

let touch0 = null; // primary finger (drawing/moving)
let touch1 = null; // second finger (pinch-zoom)
let pinchDist0 = null;

canvas.addEventListener('touchstart', (e) => {
  e.preventDefault();
  if (e.touches.length === 1) {
    touch0 = e.touches[0];
    touch1 = null;
    pinchDist0 = null;
    touchToMouse('mousedown', touch0);
  } else if (e.touches.length === 2) {
    // Second finger added ‚Äî cancel current draw, start pinch-zoom pan
    if (isDragging) {
      isDragging = false; dragMode = null; dragObj = null;
      render();
    }
    touch0 = e.touches[0];
    touch1 = e.touches[1];
    const dx = touch1.clientX - touch0.clientX;
    const dy = touch1.clientY - touch0.clientY;
    pinchDist0 = Math.sqrt(dx * dx + dy * dy);
  }
}, { passive: false });

canvas.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (e.touches.length === 1 && !touch1) {
    touch0 = e.touches[0];
    touchToMouse('mousemove', touch0);
  } else if (e.touches.length === 2) {
    const t0 = e.touches[0];
    const t1 = e.touches[1];
    const dx = t1.clientX - t0.clientX;
    const dy = t1.clientY - t0.clientY;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (pinchDist0 !== null) {
      // Pinch-zoom
      const midX = (t0.clientX + t1.clientX) / 2 - canvas.getBoundingClientRect().left;
      const midY = (t0.clientY + t1.clientY) / 2 - canvas.getBoundingClientRect().top;
      const factor = dist / pinchDist0;
      const newZoom = Math.max(0.15, Math.min(8, zoom * factor));
      panX = midX - (midX - panX) * (newZoom / zoom);
      panY = midY - (midY - panY) * (newZoom / zoom);
      zoom = newZoom;
      document.getElementById('statZoom').textContent = Math.round(zoom * 100) + '%';
      pinchDist0 = dist;
      render();
    }
  }
}, { passive: false });

canvas.addEventListener('touchend', (e) => {
  e.preventDefault();
  if (e.touches.length === 0) {
    touchToMouse('mouseup', touch0 || e.changedTouches[0]);
    touch0 = null; touch1 = null; pinchDist0 = null;
  } else if (e.touches.length === 1) {
    touch1 = null; pinchDist0 = null;
    touch0 = e.touches[0];
  }
}, { passive: false });

canvas.addEventListener('touchcancel', (e) => {
  touchToMouse('mouseup', touch0 || e.changedTouches[0]);
  touch0 = null; touch1 = null; pinchDist0 = null;
  isDragging = false; isPanning = false; dragMode = null; dragObj = null;
  render();
}, { passive: false });

// ‚îÄ‚îÄ Mobile toolbar wiring ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.mob-tool-btn[data-tool]').forEach(btn => {
  btn.addEventListener('click', () => {
    setTool(btn.dataset.tool);
    document.querySelectorAll('.mob-tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });
});

// Keep desktop + mobile tool buttons in sync
const _origSetTool = setTool;
// Wrap setTool to also update mobile buttons
function setTool(name) {
  currentTool = name;
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('tool-' + name);
  if (btn) btn.classList.add('active');
  document.querySelectorAll('.mob-tool-btn[data-tool]').forEach(b =>
    b.classList.toggle('active', b.dataset.tool === name));
  const cursors = { place: 'crosshair', select: 'default', move: 'move', resize: 'se-resize', erase: 'not-allowed' };
  canvas.style.cursor = cursors[name] || 'crosshair';
  updateHint();
}

document.getElementById('mob-btn-undo').addEventListener('click', undo);
document.getElementById('mob-btn-save').addEventListener('click', () => {
  document.getElementById('btnSave').click();
});

// ‚îÄ‚îÄ Initial render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
resizeCanvas();

</script>
</body>
</html>
